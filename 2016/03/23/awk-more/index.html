<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="死生切阔，与子成说，执子之手，与子偕老。| 这里是 Xiaoh 的个人博客 | 外接各种互联网项目">
    <meta name="keyword"  content="兴明, xiaoh, pmars, itpmars, topmars, xiaoh's Blog, 博客, 个人网站, 互联网, 开发, 产品, 后端技术，架构">
    <link rel="shortcut icon" href="../../../../img/favicon.ico">

    <title>Awk用法总结 - Xiaoh写文字的地方 | Xiaoh's Blog</title>

    <link rel="canonical" href="http://www.xiaoh.me/2016/03/23/awk-more/">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="../../../../css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="../../../../css/hux-blog.min.css">

    <!-- Pygments Github CSS -->
    <link rel="stylesheet" href="../../../../css/syntax.css">

    <!-- Custom Fonts -->
    <!-- <link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
    <!-- Hux change font-awesome CDN to qiniu -->
    <link href="http://cdn.staticfile.org/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">


    <!-- Hux Delete, sad but pending in China
    <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/
    css'>
    -->


    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- ga & ba script hoook -->
    <script></script>
</head>


<!-- hack iOS CSS :active style -->
<body ontouchstart="">

    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="../../../../index.html">Xiaoh's Blog</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="../../../../index.html">Home</a>
                    </li>
                    
                    <li>
                        <a href="../../../../about/index.html">About</a>
                    </li>
                    
                    <li>
                        <a href="../../../../tags/index.html">Tags</a>
                    </li>
                    
                </ul>
            </div>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>
<script>
    // Drop Bootstarp low-performance Navbar
    // Use customize navbar with high-quality material design animation
    // in high-perf jank-free CSS3 implementation
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    var __HuxNav__ = {
        close: function(){
            $navbar.className = " ";
            // wait until animation end.
            setTimeout(function(){
                // prevent frequently toggle
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        },
        open: function(){
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }

    // Bind Event
    $toggle.addEventListener('click', function(e){
        if ($navbar.className.indexOf('in') > 0) {
            __HuxNav__.close()
        }else{
            __HuxNav__.open()
        }
    })

    /**
     * Since Fastclick is used to delegate 'touchstart' globally
     * to hack 300ms delay in iOS by performing a fake 'click',
     * Using 'e.stopPropagation' to stop 'touchstart' event from 
     * $toggle/$collapse will break global delegation.
     * 
     * Instead, we use a 'e.target' filter to prevent handler
     * added to document close HuxNav.  
     *
     * Also, we use 'click' instead of 'touchstart' as compromise
     */
    document.addEventListener('click', function(e){
        if(e.target == $toggle) return;
        if(e.target.className == 'icon-bar') return;
        __HuxNav__.close();
    })
</script>


    <!-- Image to hack wechat -->
<!-- <img src="/img/icon_wechat.png" width="0" height="0"> -->
<!-- <img src="/img/post-bg-default.jpg" width="0" height="0"> -->

<!-- Post Header -->
<style type="text/css">
    header.intro-header{
        position: relative;
        background-image: url('../../../../img/post-bg-default.jpg')
    }

    
</style>
<header class="intro-header" >
    <div class="header-mask"></div>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <div class="tags">
                        
                        <a class="tag" href="../../../../tags/index.html#AWK" title="AWK">AWK</a>
                        
                    </div>
                    <h1>Awk用法总结</h1>
                    
                    
                    <h2 class="subheading">快速了解Awk</h2>
                    
                    <span class="meta">Posted by xiaoh on March 23, 2016</span>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

    <!-- Post Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

				<h3 id="目录">目录</h3>

<ol>
  <li><a href="index.html#awkwhatisawk">Awk是什么</a></li>
  <li><a href="index.html#commandusing">命令行语法</a></li>
  <li><a href="index.html#scriptscript">脚本（Script）组成</a></li>
  <li><a href="index.html#patternpattern">模式（Pattern）</a></li>
  <li><a href="index.html#regular-expressionregex">正则表达式（Regular Expression）</a></li>
  <li><a href="index.html#expressionsexpressions">表达式（Expressions）</a></li>
  <li><a href="index.html#array">数组</a></li>
  <li><a href="index.html#innervalue">内置变量</a>
    <ol>
      <li><a href="index.html#argvargcargvargc">ARGV与ARGC</a>
        <ol>
          <li><a href="index.html#argvdeleteargv">删除ARGV元素</a></li>
          <li><a href="index.html#argvaddingargv">增加ARGV元素</a></li>
        </ol>
      </li>
      <li><a href="index.html#convfmtofmtconvfmtofmt">CONVFMT与OFMT</a></li>
      <li><a href="index.html#environenviron">ENVIRON</a></li>
      <li><a href="index.html#rlengthrstartrlengthrstart">RLENGTH与RSTART</a></li>
    </ol>
  </li>
  <li><a href="index.html#yunsuanfu">运算符</a></li>
  <li><a href="index.html#statementstatement">语句（Statement）</a></li>
  <li><a href="index.html#mathfunction">数学函数</a></li>
  <li><a href="index.html#string">字符串函数</a>
    <ol>
      <li><a href="index.html#subsub">sub</a></li>
      <li><a href="index.html#gsubgsub">gsub</a></li>
      <li><a href="index.html#indexindex">index</a></li>
      <li><a href="index.html#lengthlength">length</a></li>
      <li><a href="index.html#matchmatch">match</a></li>
      <li><a href="index.html#splitsplit">split</a></li>
      <li><a href="index.html#sprintfsprintf">sprintf</a></li>
      <li><a href="index.html#substrsubstr">substr</a></li>
      <li><a href="index.html#tolowertolower">tolower</a></li>
      <li><a href="index.html#touppertoupper">toupper</a></li>
    </ol>
  </li>
  <li><a href="index.html#ioio">I/O处理函数</a>
    <ol>
      <li><a href="index.html#getlinegetline">getline</a></li>
      <li><a href="index.html#closeclose">close</a></li>
      <li><a href="index.html#systemsystem">system</a></li>
    </ol>
  </li>
</ol>

<hr />

<blockquote>
  <p>作为另一篇关于 <a href="http://www.xiaoh.me/2016/01/29/awk-summary/#array">Awk的文章</a> 的姐妹篇，这篇文章也是简述了Awk的使用方法。更多的内容实则是从以前的 <a href="http://www.cnblogs.com/pmars/archive/2013/01/08/2851004.html">博客</a> 摘抄过来的。记载在这里，方便学习。</p>
</blockquote>

<hr />

<h3 id="awk是什么"><a href="index.html#whatisawk">Awk是什么</a></h3>

<p>Awk、sed与grep，俗称Linux下的三剑客，它们之前有很多相似点，但是同样也各有各的特色，相似的地方是它们都可以匹配文本，其中sed和awk还可以用于文本编辑，而grep则不具备这个功用。sed是一种非交互式且面向字符流的编辑器（a “non-interactive” stream-oriented editor），而awk则是一门模式匹配的编程语言，因为它的主要功能是用于匹配文本并处理，同时它有一些编程语言才有的语法，例如函数、分支循环语句、变量等等，当然比起我们常见的编程语言，Awk相对比较简单。</p>

<p>使用Awk，我们可以做以下事情：</p>

<ul>
  <li>将文本文件视为由字段和记录组成的文本数据库；</li>
  <li>在操作文本数据库的过程中能够使用变量；</li>
  <li>能够使用数学运算和字符串操作；</li>
  <li>能够使用常见的编程结构，例如条件分支与循环；</li>
  <li>能够格式化输出；</li>
  <li>能够自定义函数；</li>
  <li>能够在awk脚本中执行UNIX命令；</li>
  <li>能够处理UNIX命令的输出结果；</li>
</ul>

<p>装备以上功能，awk能够做得事情非常多。但千里之行，始于足下，我们首先从最基本的命令行语法开始，一步一步得走入awk的编程世界。</p>

<hr />

<h3 id="命令行语法"><a href="index.html#commandusing">命令行语法</a></h3>

<p>同sed一样，awk的命令行语法也有两种形式：</p>

<div class="language-awk highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">awk</span> <span class="p">[</span><span class="o">-</span><span class="nx">F</span> <span class="nx">ERE</span><span class="p">]</span> <span class="p">[</span><span class="o">-</span><span class="nx">v</span> <span class="nx">assignment</span><span class="p">]</span> <span class="p">...</span> <span class="nx">program</span> <span class="p">[</span><span class="nx">argument</span> <span class="p">...]</span>
<span class="nx">awk</span> <span class="p">[</span><span class="o">-</span><span class="nx">F</span> <span class="nx">ERE</span><span class="p">]</span> <span class="o">-</span><span class="nx">f</span> <span class="nx">progfile</span> <span class="p">...</span>  <span class="p">[</span><span class="o">-</span><span class="nx">v</span> <span class="nx">assignment</span><span class="p">]</span> <span class="p">...[</span><span class="nx">argument</span> <span class="p">...]</span>
</code></pre></div></div>

<p>这里的program类似sed中的script，因为我们一直强调awk是一门编程语言，所以将awk的脚本视为一段代码。而awk的脚本同样可以写到一个文件中，并通过-f参数指定，这一点和sed是一样的。program一般多个pattern和action序列组成，当读入的记录匹配pattern时，才会执行相应的action命令。这里有一点要注意，在第一种形式中，除去命令行选项外，program参数一定要位于第一个位置。</p>

<p>Awk的输入被解析成多个记录（Record），默认情况下，记录的分隔符是\n，因此可以认为一行就是一个记录，记录的分隔符可以通过内置变量RS更改。当记录匹配某个pattern时，才会执行后续的action命令。</p>

<p>而每个记录由进一步地被分隔成多个字段（Field），默认情况下字段的分隔符是空白符，例如空格、制表符等等，也可以通过-F ERE选项或者内置变量FS更改。在awk中，可以通过$1，$2…来访问对应位置的字段，同时$0存放整个记录，这一点有点类似shell下的命令行位置参数。关于这些内容，我们会在下面详细介绍，这里你只要知道有这些东西就好。</p>

<p>标准的awk命令行参数主要由以下三个：</p>

<ul>
  <li>-F ERE：定义字段分隔符，该选项的值可以是扩展的正则表达式（ERE）；</li>
  <li>-f progfile：指定awk脚本，可以同时指定多个脚本，它们会按照在命令行中出现的顺序连接在一起；</li>
  <li>-v assignment：定义awk变量，形式同awk中的变量赋值，即name=value，赋值发生在awk处理文本之前；</li>
</ul>

<p>为了便于理解，这里举几个简单的例子。通过-F参数设置冒号:为分隔符，并打印各个字段：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">echo</span> <span class="s2">"1:2:3"</span> | awk <span class="nt">-F</span>: <span class="s1">'{print $1 " and " $2 " and " $3}'</span>
1 and 2 and 3
</code></pre></div></div>

<p>在awk的脚本中访问通过-v选项设置的变量：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">echo</span> | awk <span class="nt">-v</span> <span class="nv">a</span><span class="o">=</span>1 <span class="s1">'BEGIN {print a}'</span>
1
</code></pre></div></div>

<p>从上面可以看到，通过-v选项设置的变量在BEGIN的位置就可以访问了。BEGIN是一个特殊的pattern，它在awk处理输入之前就会执行，可以认为是一个初始化语句，与此对应的还有END。</p>

<p>好像还没介绍如何指定处理的文件，是不是最后的argument就是指定的文件？在看我这本书之前，我也是这样认为的，但是实际上arguemnt有两种形式，它们分别是输入文件（file）和变量赋值（assignment）。</p>

<p>awk可以同时指定多个输入文件，如果输入文件的文件名为’-‘，表示从标准输入读取内容。</p>

<p>变量赋值类似-v选项，它的形式为name=value。awk中的变量名同一般的编程语言无太多区别，但是不能同awk的保留关键字重名，可以查看awk的man手册查询哪些是保留关键字。而变量值只有两种形式：字符串和数值。变量赋值必须位于脚本参数的后面，与文件名参数无先后顺序的要求，但是位于不同位置的赋值它的执行时机是不同的。</p>

<p>我们用实际的例子来解释这个区别，假设有两个文件：a和b，它们的内容分别如下所示：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cat </span>a
file a
<span class="nb">cat </span>b
file b
</code></pre></div></div>

<p>为了说明赋值操作发生的时机，我们在BEGIN，正常处理，END三个地方都打印变量的值。</p>

<p>第一种情况： 变量赋值位于所有文件名参数之前</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>awk <span class="s1">'BEGIN {print "BEGIN: " var} {print "PROCESS: " var} END {print "END: " var }'</span> <span class="nv">var</span><span class="o">=</span>1 a
BEGIN: 
PROCESS: 1
END: 1
</code></pre></div></div>

<p>结果：赋值操作发生在正常处理之前，BEGIN动作之后。</p>

<p>第二种情况：变量赋值位于所有文件名之后：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>awk <span class="s1">'BEGIN {print "BEGIN: " var} {print "PROCESS: " var} END {print "END: " var }'</span> a <span class="nv">var</span><span class="o">=</span>1  
BEGIN: 
PROCESS: 
END: 1
</code></pre></div></div>

<p>结果：赋值操作发生在正常处理之后，END动作之前。</p>

<p>第三种情况：变量赋值位于文件名之间：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>awk <span class="s1">'BEGIN {print "BEGIN: " var} {print "PROCESS: " var} END {print "END: " var }'</span> a <span class="nv">var</span><span class="o">=</span>1 b
BEGIN: 
PROCESS: 
PROCESS: 1
END: 1
</code></pre></div></div>

<p><em>结果：赋值操作发生在处理前面的文件之后，并且位于处理后面的文件之前；</em></p>

<h5 id="总结如下">总结如下：</h5>

<ul>
  <li>如果变量赋值在第一个文件参数之前，在BEGIN动作之后执行，影响到正常处理和END动作；</li>
  <li>如果变量赋值在最后一个文件参数之后，在END动作之前执行，仅影响END动作；</li>
  <li>如果文件参数不存在，情况同1所述；</li>
  <li>如果变量赋值位于多个文件参数之间，在变量赋值前面的文件被处理后执行，影响到后续文件的处理和END动作；</li>
</ul>

<p>所以变量赋值一定要考虑清楚用途，否则比较容易出错，不过一般情况下也不会用到变量赋值。</p>

<p>自然地大家会将变量赋值与-v assignment选项进行比较，赋值的形式是一致的，但是-v选项的执行时机比变量赋值要早：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">echo </span>1 | awk <span class="nt">-v</span> <span class="nv">var</span><span class="o">=</span>a <span class="s1">'BEGIN {print "BEGIN: " var}'</span>
BEGIN: a
</code></pre></div></div>

<p>可见，-v选项的赋值操作在BEGIN动作之前就执行了。</p>

<p>变量赋值一定要小心不要与保留关键字重名，否则会报错：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">echo </span>1 | awk <span class="nt">-v</span> <span class="nv">BEGIN</span><span class="o">=</span>1 <span class="s1">'BEGIN {print "BEGIN: " BEGIN}'</span>
awk: fatal: cannot use gawk <span class="nb">builtin</span> <span class="sb">`</span>BEGIN<span class="s1">' as variable name
</span></code></pre></div></div>

<hr />

<h3 id="记录record与字段field"><a href="https://xiaoh.me/2016/03/23/awk-more/recordandfield">记录（Record）与字段（Field)</a></h3>

<p>对于数据库来说，一个数据库表是由多条记录组成的，每一行表示一条记录（Record）。每条记录由多列组成，每一列表示一个字段（Field)。Awk将一个文本文件视为一个文本数据库，因此它也有记录和字段的概念。默认情况下，记录的分隔符是回车，字段的分隔符是空白符，所以文本文件的每一行表示一个记录，而每一行中的内容被空白分隔成多个字段。利用字段和记录，awk就可以非常灵活地处理文件的内容。</p>

<p>可以通过-F选项来修改默认的字段分隔符，例如/etc/passwd的每一行都是由冒号分隔成多个字段的，所以这里就需要将分隔符设置成冒号：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>awk <span class="nt">-F</span>: <span class="s1">'{print $1}'</span> /etc/passwd | head <span class="nt">-3</span>
root
bin
daemon
</code></pre></div></div>

<p>这里通过$1引用第一人字段，类似地$2表示第二个字段，$3表示第三个字段…. $0则表示整个记录。内置变量NF记录着字段的个数，所以$NF表示最后一个字段：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>awk <span class="nt">-F</span>: <span class="s1">'{print $NF}'</span> /etc/passwd | head <span class="nt">-3</span>
/bin/bash
/bin/false
/bin/false
</code></pre></div></div>

<p>当然，$(NF-1)表示倒数第二个。</p>

<p>内置变量FS也可以用于更改字段分隔符，它记录着当前的字段分隔符：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>awk <span class="nt">-F</span>: <span class="s1">'{print FS}'</span> /etc/passwd | head <span class="nt">-1</span>
:
awk <span class="nt">-v</span> <span class="nv">FS</span><span class="o">=</span>: <span class="s1">'{print $1}'</span> /etc/passwd | head <span class="nt">-1</span>
root
</code></pre></div></div>

<p>记录的分隔符可以通过内置变量RS更改：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>awk <span class="nt">-v</span> <span class="nv">RS</span><span class="o">=</span>: <span class="s1">'{print $0}'</span> /etc/passwd | head <span class="nt">-1</span>
root
</code></pre></div></div>

<p>如果将RS设置成空，行为有就一点怪异了，它会将连续不为空行的所有行（一个段落）当作一个记录，而且强制回车为字段分隔符：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cat </span>awk_man.txt 
The awk utility shall execute programs written <span class="k">in </span>the awk programming language,
which is specialized <span class="k">for </span>textual data manipulation. An awk program is a sequence
of patterns and corresponding actions.  When  input  is  <span class="nb">read  </span>that matches a 
pattern, the action associated with that pattern is carried out.

Input shall be interpreted as a sequence of records. By default, a record is a line, 
less its terminating &lt;newline&gt;, but this can be changed by using the RS built-in 
variable. Each record of input shall be matched <span class="k">in </span>turn against each pattern <span class="k">in </span>the 
program. For each pattern matched, the associated action shall be executed.

awk <span class="s1">'BEGIN {RS="";FS=":"} {print "First line: " $1}'</span> awk_man.txt 
First line: The awk utility shall execute programs written <span class="k">in </span>the awk programming language,
First line: Input shall be interpreted as a sequence of records. By default, a record is a line,
</code></pre></div></div>

<p>这里，我们将变量赋值放到BEGIN动作中执行，因为BEGIN动作是在文件处理之前执行的，专门用于放初始化的语句。FS的赋值在这里是无效的，awk依然使用回车符来分隔字段。</p>

<hr />

<h3 id="脚本script组成"><a href="index.html#script">脚本（Script）组成</a></h3>

<p>命令行中的program部分，可以称为awk代码,也可以称为awk脚本。一段awk脚本是由多个’pattern { action }‘序列组成的。action是一个或者多个语句，它在输入行匹配pattern的时候被执行。如果pattern为空，表明这个action会在每一行处理时都会被执行。下面的例子简单地打印文件的每一行，这里不带任何参数的print语句打印的是整个记录，类似’print $0‘：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">echo</span> <span class="nt">-e</span> <span class="s1">'line1\nline2'</span> | awk <span class="s1">'{print}'</span>
line1
line2
</code></pre></div></div>

<p>除了pattern { action }，还可以在脚本中定义自定义的函数，函数定义格式如下所示：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function </span>name<span class="o">(</span>parameter list<span class="o">)</span> <span class="o">{</span> statements <span class="o">}</span>
</code></pre></div></div>

<p>函数的参数列表用逗号分隔，参数默认是局部变量，无法在函数之外访问，而在函数中定义的变量为全局变量，可以在函数之外访问，如：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">echo </span>line1 | awk <span class="s1">'
function t(a) {
    b=a;
    print a;
} 
{
    print b;
    t("kodango.me"); 
    print b;
}'</span>
kodango.me
kodango.me
</code></pre></div></div>

<p>Awk脚本中的语句使用空行或者分号分隔，使用分号可以放在同一行，不过有时候会影响可读性，尤其是分支或循环结构中，很容易出错。</p>

<p>如果Awk中的一个语句太长，要分成多行，可以在行为使用反斜杠’'：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cat </span>test.awk
<span class="k">function </span>t<span class="o">(</span>a<span class="o">)</span>
<span class="o">{</span>
        <span class="nv">b</span><span class="o">=</span>a
        print <span class="s2">"This is a very long line, so use backslash to escape the newline then we will print the variable a: a="</span> a
<span class="o">}</span> 
<span class="o">{</span> print b<span class="p">;</span> t<span class="o">(</span><span class="s2">"kodango.me"</span><span class="o">)</span><span class="p">;</span> print b<span class="p">;</span><span class="o">}</span>
<span class="nb">echo </span>1 | awk <span class="nt">-f</span> test.awk

This is a very long line, so use backslash to escape the newline <span class="k">then </span>we will print the variable a: <span class="nv">a</span><span class="o">=</span>kodango.me
kodango.me
</code></pre></div></div>

<table>
  <tbody>
    <tr>
      <td>这里我们将脚本写到文件中，并通过-f参数来指定。但是，在一些特殊符号之后，是可以直接换行的，例如”, { &amp;&amp;</td>
      <td> </td>
      <td>”。</td>
    </tr>
  </tbody>
</table>

<hr />

<h3 id="模式pattern"><a href="index.html#pattern">模式（Pattern）</a></h3>

<p>模式是awk中比较重要的一部分，它有以下几种情况：</p>

<ul>
  <li>/regular expression/： 扩展的正则表达式（Extended Regular Expression）， 关于ERE可以参考 <a href="http://www.infoq.com/cn/news/2011/07/regular-expressions-6-POSIX">这篇文章</a>；</li>
  <li>relational expression： 关系表达式，例如大于、小于、等于，关系表达式结果为true表示匹配；</li>
  <li>BEGIN： 特殊的模式，在第一个记录处理之前被执行，常用于初始化语句的执行；</li>
  <li>END： 特殊的模式，在最后一个记录处理之前被执行，常用于输出汇总信息；</li>
  <li>pattern, pattern：模式对，匹配两者之间的所有记录，类似sed的地址对；</li>
</ul>

<p>例如查找匹配数字3的行：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>seq 1 20 | awk <span class="s1">'/3/ {print}'</span>
3
13
</code></pre></div></div>

<p>相反地，可以在在正则表达式之前加上’!’表示不匹配：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>seq 1 5 | awk <span class="s1">'!/3/ {print}'</span>
1
2
4
5
</code></pre></div></div>

<table>
  <tbody>
    <tr>
      <td>除了BEGIN和END这两个特殊的模式外，其余的模式都可以使用’&amp;&amp;’或者’</td>
      <td> </td>
      <td>’运算符组合，前者表示逻辑与，后者表示逻辑或：</td>
    </tr>
  </tbody>
</table>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>seq 1 50 | awk <span class="s1">'/3/ &amp;&amp; /1/ {print}'</span>
13
31
</code></pre></div></div>

<p>前面的正则都是整行匹配，有时候仅仅需要匹配某个字符，这样我们可以用表达式$n ~ /ere/：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>awk <span class="s1">'$1 ~ /xi/ {print}'</span> /etc/passwd
xingming:x:1000:1000::/home/xingming:/bin/bash
</code></pre></div></div>

<p>有时候我们只想显示特定和行，例如显示第一行：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>seq 1 5 | awk <span class="s1">'NR==1 {print}'</span>
1
</code></pre></div></div>

<hr />

<h3 id="正则表达式regular-expression"><a href="index.html#regex">正则表达式（Regular Expression）</a></h3>

<p>正则表达式的内容介绍起来太麻烦，还是推荐同学阅读现有的文章（如 <a href="http://www.infoq.com/cn/news/2011/07/regular-expressions-6-POSIX">Linux/Unix工具与正则表达式的POSIX规范</a>），里面对各个流派的正则表达式归纳地很清楚了。</p>

<hr />

<h3 id="表达式expressions"><a href="index.html#expressions">表达式（Expressions）</a></h3>

<p>表达式可以由常量、变量、运算符和函数组成，常数和变量的值可以为字符串和数值。</p>

<p>Awk中的变量有三种类型：用户定义的变量，内置变量和字段变量。其中，内置变量名都是大写的。变量并不非一定要被声明或者被初始化，未初始化的字符串变量的值为””，未初始化的数值变量的值为0。字段变量可以用$n来引用，n的取值范围为[0,NF]。n可以为一个变量，例如$NF代码最后一个字段，而$(NF-1)表示倒数第二个字段。</p>

<hr />

<h3 id="数组"><a href="index.html#array">数组</a></h3>

<p>数组是一种特殊的变量，在awk中，比较特殊地是，数组的下标可以为数字或者字符串。数组的赋值很简单，下面将value赋值给数组下标为index的元素：<code class="highlighter-rouge">array[index]=value</code></p>

<p>可以用for..in..语法遍历数组元素，其中item是数组元素对应的下标：<code class="highlighter-rouge">for (item in array)</code></p>

<p>当然也可以在if分支判断中使用in操作符：<code class="highlighter-rouge">if (item in array)</code></p>

<p>一个完整的例子如下所示：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">echo</span> <span class="s2">"1 2 3"</span> | awk <span class="s1">'{
    for (i=0;i&lt;NF;i++)
          a[i]=i;
}
 
END {
    print 3 in a
        for (i in a)
               printf "%s: %s\n", i, a[i];
}'</span>
0
0: 0
1: 1
2: 2
</code></pre></div></div>

<hr />

<h3 id="内置变量"><a href="index.html#innervalue">内置变量</a></h3>

<p>Awk在内部维护了许多内置变量，或者称为系统变量，例如之前提到的FS、RS等等。常见的内置变量如下表所示</p>

<table>
  <thead>
    <tr>
      <th>变量名</th>
      <th>描述</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>ARGC</td>
      <td>命令行参数的各个，即ARGV数组的长度</td>
    </tr>
    <tr>
      <td>ARGV</td>
      <td>存放命令行参数</td>
    </tr>
    <tr>
      <td>CONVFMT</td>
      <td>定义awk内部数值转换成字符串的格式，默认值为”%.6g”</td>
    </tr>
    <tr>
      <td>OFMT</td>
      <td>定义输出时数值转换成字符串的格式，默认值为”%.6g”</td>
    </tr>
    <tr>
      <td>ENVIRON</td>
      <td>存放系统环境变量的关联数组</td>
    </tr>
    <tr>
      <td>FILENAME</td>
      <td>当前被处理的文件名</td>
    </tr>
    <tr>
      <td>NR</td>
      <td>记录的总个数</td>
    </tr>
    <tr>
      <td>FNR</td>
      <td>当前文件中的记录的总个数</td>
    </tr>
    <tr>
      <td>FS</td>
      <td>字段分隔符，默认为空白</td>
    </tr>
    <tr>
      <td>NF</td>
      <td>每个记录中字段的个数</td>
    </tr>
    <tr>
      <td>RS</td>
      <td>记录的分隔符，默认为回车</td>
    </tr>
    <tr>
      <td>OFS</td>
      <td>输出时字段的分隔符，默认为空白</td>
    </tr>
    <tr>
      <td>ORS</td>
      <td>输出时记录的分隔符，默认为回车</td>
    </tr>
    <tr>
      <td>RLENGTH</td>
      <td>被match函数匹配的子串长度</td>
    </tr>
    <tr>
      <td>RSTART</td>
      <td>被match函数匹配的子串位于目标字符串的起始下标</td>
    </tr>
  </tbody>
</table>

<p>下面主要介绍几个比较难理解的内置变量：</p>

<h5 id="argv与argc"><a href="index.html#argvargc">ARGV与ARGC</a></h5>

<p>ARGV与ARGC的意思比较好理解，就像C语言 <code class="highlighter-rouge">main(int argc, char **argv)</code>。ARGV数组的下标从0开始到ARGC-1，它存放的是命令行参数，并且排除命令行选项（例如-v/-f）以及program部分。因此事实上ARGV只是存储argument的部分，即文件名（file）以及命令行变量赋值两部分的内容。</p>

<p>通过下面的例子可以大概了解ARGC与ARGV的用法：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>awk <span class="s1">'BEGIN {
    for (i = 0; i &lt; ARGC; i++)
        print ARGV[i]
}'</span> inventory-shipped BBS-list
awk
inventory-shipped
BBS-list
</code></pre></div></div>

<p>ARGV的用法不仅限于此，它是可以修改的，可以更改数组元素的值，可以增加数组元素或者删除数组元素。</p>

<h6 id="更改argv元素的值">更改ARGV元素的值</h6>

<p>假设我们有a, b两个文件，它们各有一行内容：file a和file b。现在利用ARGV，我们可以做到偷梁换柱：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>awk <span class="s1">'BEGIN{ARGV[1]="b"} {print}'</span> a
file b
</code></pre></div></div>

<p>这里要注意ARGV[1]=”b”的引号不能缺少，否则ARGV[1]=b会将变量b的值赋值给ARGV[1]。</p>

<p>当awk处理完一个文件之后，它会从ARGV的下一个元素获取参数，如果是一个文件则继续处理，如果是一个变量赋值则执行赋值操作：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>awk <span class="s1">'BEGIN{ARGV[1]="var=1"} {print var}'</span> a b
1
</code></pre></div></div>

<p>当下一个元素为空时，则跳过不处理，这样可以避开处理某个文件：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>awk <span class="s1">'BEGIN{ARGV[1]=""} {print}'</span> a b
file b
</code></pre></div></div>

<p>上面的例子中a这个文件就被跳过了。</p>

<p>而当下一个元素的值为”-”时，表明从标准输入读取内容：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>awk <span class="s1">'BEGIN{ARGV[1]="-"} {print}'</span> a b
a
a    <span class="c"># --&gt; 这里按下CTRL+D停止输入</span>
file b
</code></pre></div></div>

<h6 id="删除argv元素"><a href="index.html#deleteargv">删除ARGV元素</a></h6>

<p>删除ARGV元素和将元素的值赋值为空的效果是一样的，它们都会跳转对某个参数的处理：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>awk <span class="s1">'BEGIN{delete ARGV[1]} {print}'</span> a b
file b
</code></pre></div></div>

<p>删除数组元素可以用delete语句。</p>

<h6 id="增加argv元素"><a href="index.html#addingargv">增加ARGV元素</a></h6>

<p>我第一次看到ARGV变量的时候就在想，能不能利用ARGV变量避免提供命令行参数，就像这样: <code class="highlighter-rouge">awk 'BEGIN{ARGV[1]="a";} {print}'</code></p>

<p>但是事实上这样不行，awk会依然从标准输入中获取内容。下面的方法倒是可以，首先增加ARGC的值，再增加ARGV元素，我到现在也没搞懂这两者的区别：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>awk <span class="s1">'BEGIN{ARGC+=1;ARGV[1]="a"} {print}'</span>
file a
</code></pre></div></div>

<h5 id="convfmt与ofmt"><a href="index.html#convfmtofmt">CONVFMT与OFMT</a></h5>

<p>Awk中允许数值到字符串相互转换，其中内置变量CONVFMT定义了awk内部数值到字符串转换的格式，它的默认值为”%.6g”：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>awk <span class="s1">'BEGIN {
    printf "CONVFMT=%s, num=%f, str=%s\n", CONVFMT, 12.11, 12.11
}'</span>
<span class="nv">CONVFMT</span><span class="o">=</span>%.6g, <span class="nv">num</span><span class="o">=</span>12.110000, <span class="nv">str</span><span class="o">=</span>12.11
</code></pre></div></div>

<p>通过更改CONVFMT，我们可以定义自己的转换格式：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>awk <span class="s1">'BEGIN { 
    CONVFMT="%d";
    printf "CONVFMT=%s, num=%f, str=%s\n", CONVFMT, 12.11, 12.11 
}'</span>
<span class="nv">CONVFMT</span><span class="o">=</span>%d, <span class="nv">num</span><span class="o">=</span>12.110000, <span class="nv">str</span><span class="o">=</span>12
</code></pre></div></div>

<p>与此对应地还有一个内置变量 <em>OFMT</em>，它与CONVFMT的作用是类似的，只不过是影响输出的时候数字转换成字符串的格式：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>awk <span class="s1">'BEGIN { OFMT="%d";print 12.11 }'</span> 
12
</code></pre></div></div>

<h5 id="environ"><a href="index.html#environ">ENVIRON</a></h5>

<p>ENVIRON是一个存放系统环境变量的关联数组，它的下标是环境变量名称，值是相应环境变量的值。例如：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>awk <span class="s1">'BEGIN { print ENVIRON["USER"] }'</span> 
xingming
</code></pre></div></div>

<p>利用环境变量也可以将值传递给awk：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">U</span><span class="o">=</span>hello awk <span class="s1">'BEGIN { print ENVIRON["U"] }'</span> 
hello
</code></pre></div></div>

<p>可以利用for..in循环遍历ENVIRON数组：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>awk <span class="s1">'BEGIN { 
    for (env in ENVIRON) 
        printf "%s=%s\n", env, ENVIRON[env]; 
}'</span>
</code></pre></div></div>

<h5 id="rlength与rstart"><a href="index.html#rlengthrstart">RLENGTH与RSTART</a></h5>

<p>RLENGTH与RSTART都是与match函数相关的，前者表示匹配的子串长度，后者表示匹配的子串位于目标字符串的起始下标。例如：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>awk <span class="s1">'BEGIN {match("hello,world", /llo/); print RSTART,RLENGTH}'</span>
3 3
</code></pre></div></div>

<hr />

<h3 id="运算符"><a href="index.html#yunsuanfu">运算符</a></h3>

<p>表达式中必然少不了运算符，awk支持的运算符可以参见man手册中的“Expressions in awk”一小节内容：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>man awk | <span class="nb">grep</span> <span class="s2">"^ *Table: Expressions in"</span> <span class="nt">-A</span> 42 | sed <span class="s1">'s/^ *//'</span>
Table: Expressions <span class="k">in </span>Decreasing Precedence <span class="k">in </span>awk
 
Syntax                Name                      Type of Result   Associativity
<span class="o">(</span> expr <span class="o">)</span>              Grouping                  Type of expr     N/A
<span class="nv">$expr</span>                 Field reference           String           N/A
++ lvalue             Pre-increment             Numeric          N/A
<span class="nt">--</span> lvalue             Pre-decrement             Numeric          N/A
lvalue ++             Post-increment            Numeric          N/A
lvalue <span class="nt">--</span>             Post-decrement            Numeric          N/A
expr ^ expr           Exponentiation            Numeric          Right
<span class="o">!</span> expr                Logical not               Numeric          N/A
 
+ expr                Unary plus                Numeric          N/A
- expr                Unary minus               Numeric          N/A
expr <span class="k">*</span> expr           Multiplication            Numeric          Left
 
...以下省略...
</code></pre></div></div>

<hr />

<h3 id="语句statement"><a href="index.html#statement">语句（Statement）</a></h3>

<p>到目前为止，用得比较多的语句就是print，其它的还有printf、delete、break、continue、exit、next等等。这些语句与函数不同的是，它们不会使用带括号的参数，并且没有返回值。不过也有意外，比如printf就可以像函数一样的调用：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">echo </span>1 | awk <span class="s1">'{printf("%s\n", "abc")}'</span>
abc
</code></pre></div></div>

<p>break和continue语句，大家应该比较了解，分别用于跳出循环和跳到下一个循环。</p>

<p>delete用于删除数组中的某个元素，这个我们在上面介绍ARGV的时候也使用过。</p>

<p>exit的用法顾名思义，就是退出awk的处理，然后会执行END部分的内容：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">echo</span> <span class="s1">$'line1</span><span class="se">\n</span><span class="s1">line2'</span> | awk <span class="s1">'{print;exit} END {print "exit.."}'</span>
line1
exit..
</code></pre></div></div>

<p>next语句类似sed的n命令，它会读取下一条记录，并重新回到脚本的最开始处执行：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">echo</span> <span class="s1">$'line1</span><span class="se">\n</span><span class="s1">line2'</span> | awk <span class="s1">'{
    print "Before next.."
    print $0 
    next
    print "After next.."
}'</span>
Before next..
line1
Before next..
line2
</code></pre></div></div>

<p>从上面可以看出next后面的print语句不会执行。</p>

<p>print与printf语句是使用最多的，它们将内容输出到标准输出。注意在print语句中，输出的变量之间带不带逗号是有区别的：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">echo</span> <span class="s2">"1 2"</span> | awk <span class="s1">'{print $1, $2}'</span>
1 2
<span class="nb">echo</span> <span class="s2">"1 2"</span> | awk <span class="s1">'{print $1 $2}'</span>
12
</code></pre></div></div>

<p>print输出时，字段之间的分隔符可以由OFS重新定义：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"1 2"</span> | awk <span class="s1">'{OFS=";";print $1,$2}'</span>
1<span class="p">;</span>2
</code></pre></div></div>

<p>除此之外，print的输出还可以重定向到某个文件中或者某个命令：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>print items <span class="o">&gt;</span> output-file
print items <span class="o">&gt;&gt;</span> output-file
print items | <span class="nb">command</span>
</code></pre></div></div>

<p>假设有这一样一个文件，第一列是语句名称，第二列是对应的说明：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">cat </span>column.txt 
statement|description
delete|delete item from an array
<span class="nb">exit</span>|exit from the awk process
next|read next input record and process
</code></pre></div></div>

<p>现在我们要将两列的内容分别输出到statement.txt和description.txt两个文件中：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>awk <span class="nt">-F</span><span class="s1">'|'</span> <span class="s1">'{
    print $1 &gt; "statement.txt";
    print $2 &gt; "description.txt"
}'</span> column.txt 
<span class="o">[</span>kodango@devops awk_temp]<span class="nv">$ </span><span class="nb">cat </span>statement.txt 
statement
delete
<span class="nb">exit
</span>next
<span class="o">[</span>kodango@devops awk_temp]<span class="nv">$ </span><span class="nb">cat </span>description.txt 
description
delete item from an array
<span class="nb">exit </span>from the awk process
<span class="nb">read </span>next input record and process
</code></pre></div></div>

<p>下面是一个重定向到命令的例子，假设我们要对下面的文件进行排序：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">cat </span>num.list 
1
3
2
9
5
</code></pre></div></div>

<p>可以通过将print的内容重定向到”sort -n”命令：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>awk <span class="s1">'{print | "sort -n"}'</span> num.list 
1
2
3
5
9
</code></pre></div></div>

<p>printf命令的用法与print类似，也可以重定向到文件或者输出，只不过printf比print多了格式化字符串的功能。printf的语法也大多数语言包括bash的printf命令类似，这里就不多介绍了。</p>

<hr />

<h3 id="数学函数"><a href="index.html#mathfunction">数学函数</a></h3>

<p>awk中支持以下数学函数：</p>

<ul>
  <li>atan2(y,x)：反正切函数；</li>
  <li>cos(x)：余弦函数；</li>
  <li>sin(x)：正弦函数；</li>
  <li>exp(x)：以自然对数e为底指数函数；</li>
  <li>log(x)：计算以e 为底的对数值；</li>
  <li>sqrt(x)：开平方函数；</li>
  <li>int(x)：将数值转换成整数（绝对值）；</li>
  <li>rand()：返回0到1的一个随机数值，不包含1；</li>
  <li>srand([expr])：设置随机种子，一般与rand函数配合使用，如果参数为空，默认使用当前时间为种子；</li>
</ul>

<p>例如，我们使用rand()函数生成一个随机数值：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>awk <span class="s1">'BEGIN {print rand(),rand();}'</span>
0.237788 0.291066
<span class="nv">$ </span>awk <span class="s1">'BEGIN {print rand(),rand();}'</span>
0.237788 0.291066
</code></pre></div></div>

<p>但是你会发现，每次awk执行都会生成同样的随机数，但是在一次执行过程中产生的随机数又是不同的。因为每次awk执行都使用了同样的种子，所以我们可以用srand()函数来设置种子:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>awk <span class="s1">'BEGIN {srand();print rand(),rand();}'</span>
0.171625 0.00692412
<span class="nv">$ </span>awk <span class="s1">'BEGIN {srand();print rand(),rand();}'</span>
0.43269 0.782984
</code></pre></div></div>

<p>这样每次生成的随机数就不一样了。</p>

<p>利用rand()函数我们也可以生成1到n的整数：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>awk <span class="s1">'
    function randint(n) { return int(n*rand()); }
    BEGIN { srand(); print randint(10);
}'</span>
3
</code></pre></div></div>

<hr />

<h3 id="字符串函数"><a href="index.html#string">字符串函数</a></h3>

<p>awk中包含大多数常见的字符串操作函数。</p>

<h5 id="sub"><a href="index.html#sub">sub</a></h5>

<p><em>sub(ere, repl[, in])</em></p>

<p>描述：简单地说，就是将in中匹配ere的部分替换成repl，返回值是替换的次数。如果in参数省略，默认使用$0。替换的动作会直接修改变量的值。</p>

<p>下面是一个简单的替换的例子：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"hello, world"</span> | awk <span class="s1">'{print sub(/ello/, "i"); print}'</span>
1
hi, world
</code></pre></div></div>

<p>在repl参数中&amp;是一个元字符，它表示匹配的内容，例如：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>awk <span class="s1">'BEGIN {var="kodango"; sub(/kodango/, "hello, &amp;", var); print var}'</span>
hello, kodango
</code></pre></div></div>

<h5 id="gsub"><a href="index.html#gsub">gsub</a></h5>

<p><em>gsub(ere, repl[, in])</em></p>

<p>描述：同sub()函数功能类似，只不过是gsub()是全局替换，即替换所有匹配的内容。</p>

<h5 id="index"><a href="index.html#index">index</a></h5>

<p><em>index(s, t)</em></p>

<p>描述：返回字符串t在s中出现的位置，注意这里位置是从1开始计算的，如果没有找到则返回0。</p>

<p>例如：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>awk <span class="s1">'BEGIN {print index("xingming", "n")}'</span>
2
<span class="nv">$ </span>awk <span class="s1">'BEGIN {print index("xingming", "w")}'</span>
0
</code></pre></div></div>

<h5 id="length"><a href="index.html#length">length</a></h5>

<p><em>length[([s])]</em></p>

<p>描述：返回字符串的长度，如果参数s没有指定，则默认使用$0作为参数。</p>

<p>例如：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>awk <span class="s1">'BEGIN {print length('</span>xingming<span class="s1">');}'</span>
8
<span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"first line"</span> | awk <span class="s1">'{print length();}'</span>
10
</code></pre></div></div>

<h5 id="match"><a href="index.html#match">match</a></h5>

<p><em>match(s, ere)</em></p>

<p>描述： 返回字符串s匹配ere的起始位置，如果不匹配则返回0。该函数会定义RSTART和RLENGTH两个内置变量。RSTART与返回值相同，RLENGTH记录匹配子串的长度，如果不匹配则为-1。</p>

<p>例如：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>awk <span class="s1">'BEGIN {
print match("xingming", /ngmin/);
printf "Matched at: %d, Matched substr length: %d\n", RSTART, RLENGTH;
}'</span>
3
Matched at: 3, Matched substr length: 5
</code></pre></div></div>

<h5 id="split"><a href="index.html#split">split</a></h5>

<p><em>split(s, a[, fs])</em></p>

<p>描述：将字符串按照分隔符fs，分隔成多个部分，并存到数组a中。注意，存放的位置是从第1个数组元素开始的。如果fs为空，则默认使用FS分隔。函数返回值分隔的个数。</p>

<p>例如：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>awk <span class="s1">'BEGIN {
    split("1;2;3;4;5", arr, ";")
    for (i in arr)
        printf "arr[%d]=%d\n", i, arr[i];
}'</span>
arr[4]<span class="o">=</span>4
arr[5]<span class="o">=</span>5
arr[1]<span class="o">=</span>1
arr[2]<span class="o">=</span>2
arr[3]<span class="o">=</span>3
</code></pre></div></div>

<p>这里有一个奇怪的地方是for..in..输出的数组不是按顺序输出的，如果要按顺序输出可以用常规的for循环:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>awk <span class="s1">'BEGIN {
    n=split("1;2;3;4;5", arr, ";")
    for (i=1; i&lt;=n; i++)
        printf "arr[%d]=%d\n", i, arr[i];
}'</span>
arr[1]<span class="o">=</span>1
arr[2]<span class="o">=</span>2
arr[3]<span class="o">=</span>3
arr[4]<span class="o">=</span>4
arr[5]<span class="o">=</span>5
</code></pre></div></div>

<h5 id="sprintf"><a href="index.html#sprintf">sprintf</a></h5>

<p><em>sprintf(fmt, expr, expr, …)</em></p>

<p>描述：类似printf，只不过不会将格式化后的内容输出到标准输出，而是当作返回值返回。</p>

<p>例如：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>awk <span class="s1">'BEGIN {
    var=sprintf("%s=%s", "name", "value")
    print var
}'</span>
<span class="nv">name</span><span class="o">=</span>value
</code></pre></div></div>

<h5 id="substr"><a href="index.html#substr">substr</a></h5>

<p><em>substr(s, m[, n])</em></p>

<p>描述：返回从位置m开始的，长度为n的子串，其中位置从1开始计算，如果未指定n或者n值大于剩余的字符个数，则子串一直到字符串末尾为止。</p>

<p>例如：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>awk <span class="s1">'BEGIN { print substr("xiaoh.me", 2, 3); }'</span>
iao
awk <span class="s1">'BEGIN { print substr("xiaoh.me", 2); }'</span>
iaoh.me
</code></pre></div></div>

<h5 id="tolower"><a href="index.html#tolower">tolower</a></h5>

<p><em>tolower(s)</em></p>

<p>描述：将字符串转换成小写字符。</p>

<p>例如：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>awk <span class="s1">'BEGIN {print tolower("XIAOH.ME");}'</span>
xiaoh.me
</code></pre></div></div>

<h5 id="toupper"><a href="index.html#toupper">toupper</a></h5>

<p><em>toupper(s)</em></p>

<p>描述：将字符串转换成大写字符。</p>

<p>例如</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>awk <span class="s1">'BEGIN {print toupper('</span>xiaoh.me<span class="s1">')}'</span>
XIAOH.ME
</code></pre></div></div>

<hr />

<h3 id="io处理函数"><a href="index.html#io">I/O处理函数</a></h3>

<h5 id="getline"><a href="index.html#getline">getline</a></h5>

<p>getline的用法相对比较复杂，它有几种不同的形式。不过它的主要作用就是从输入中每次获取一行输入。</p>

<h6 id="expression--getline-var"><code class="highlighter-rouge">expression | getline [var]</code></h6>

<p>这种形式将前面管道前命令输出的结果作为getline的输入，每次读取一行。如果后面跟有var，则将读取的内容保存到var变量中，否则会重新设置$0和NF。</p>

<p>例如，我们将上面的statement.txt文件的内容显示作为getline的输入：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>awk <span class="s1">'BEGIN { while("cat statement.txt" | getline var) print var}'</span>
statement
delete
<span class="nb">exit
</span>next
</code></pre></div></div>

<p>上面的例子中命令要用双引号，<code class="highlighter-rouge">cat statement.txt</code>，这一点同print/printf是一样的。</p>

<p>如果不加var，则直接写到$0中，注意NF值也会被更新：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>awk <span class="s1">'BEGIN { while("cat statement.txt" | getline) print $0,NF}'</span>
statement 1
delete 1
<span class="nb">exit </span>1
next 1
</code></pre></div></div>

<h6 id="getline-var"><code class="highlighter-rouge">getline [var]</code></h6>

<p>第二种形式是直接使用getline，它会从处理的文件中读取输入。同样地，如果var没有，则会设置$0，并且这时候会更新NF, NR和FNR：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>awk <span class="s1">'{
    while (getline) 
       print NF, NR, FNR, $0;
}'</span> statement.txt
1 2 2 delete
1 3 3 <span class="nb">exit
</span>1 4 4 next
</code></pre></div></div>

<h6 id="getline-var--expression"><code class="highlighter-rouge">getline [var] &lt; expression</code></h6>

<p>第三种形式从expression中重定向输入，与第一种方法类似，这里就不加赘述了。</p>

<h5 id="close"><a href="index.html#close">close</a></h5>

<p>close函数可以用于关闭已经打开的文件或者管道，例如getline函数的第一种形式用到管道，我们可以用close函数把这个管道关闭，close函数的参数与管道的命令一致：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>awk <span class="s1">'BEGIN {
    while("cat statement.txt" | getline) {
        print $0;
        close("cat statement.txt");
}}'</span>
statement
statement
statement
statement
statement
</code></pre></div></div>

<p>但是每次读了一行后，关闭管道，然后重新打开又重新读取第一行就死循环了。所以要慎用，一般情况下也很少会用到close函数。</p>

<h5 id="system"><a href="index.html#system">system</a></h5>

<p>这个函数很简单，就是用于执行外部命令，例如：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>awk <span class="s1">'BEGIN {system("uname -r");}'</span>
3.6.2-1-ARCH
</code></pre></div></div>

<hr />

<h3 id="结束语">结束语</h3>

<p>快速了解Awk系列的几篇文章相对比较粗糙，我是参考Awk的man手册以及《Sed &amp; Awk》附录B总结而成的，但是应该可以让大家对awk有一个大致的了解，欢迎大家一起交流。</p>

<hr />

<h3 id="end">END</h3>



                <hr>

                


                <ul class="pager">
                    
                    <li class="previous">
                        <a href="../../22/free-dev/index.html" data-toggle="tooltip" data-placement="top" title="Free For DEV">
                        Previous<br>
                        <span>Free For DEV</span>
                        </a>
                    </li>
                    
                    
                    <li class="next">
                        <a href="../../27/python-decorator/index.html" data-toggle="tooltip" data-placement="top" title="Python装饰器入门与提高">
                        Next<br>
                        <span>Python装饰器入门与提高</span>
                        </a>
                    </li>
                    
                </ul>


                

                

            </div>

    <!-- Sidebar Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                <!-- Featured Tags -->
                
                <section>
                    <hr class="hidden-sm hidden-xs">
                    <h5><a href="../../../../tags/index.html">FEATURED TAGS</a></h5>
                    <div class="tags">
        				
                            
                				<a href="../../../../tags/index.html#杂谈" title="杂谈" rel="4">
                                    杂谈
                                </a>
                            
        				
                            
                				<a href="../../../../tags/index.html#Python" title="Python" rel="17">
                                    Python
                                </a>
                            
        				
                            
                				<a href="../../../../tags/index.html#Ubuntu" title="Ubuntu" rel="3">
                                    Ubuntu
                                </a>
                            
        				
                            
        				
                            
        				
                            
                				<a href="../../../../tags/index.html#Flask" title="Flask" rel="3">
                                    Flask
                                </a>
                            
        				
                            
                				<a href="../../../../tags/index.html#Redis" title="Redis" rel="3">
                                    Redis
                                </a>
                            
        				
                            
                				<a href="../../../../tags/index.html#数据库" title="数据库" rel="2">
                                    数据库
                                </a>
                            
        				
                            
        				
                            
                				<a href="../../../../tags/index.html#Supervisor" title="Supervisor" rel="2">
                                    Supervisor
                                </a>
                            
        				
                            
                				<a href="../../../../tags/index.html#服务器" title="服务器" rel="6">
                                    服务器
                                </a>
                            
        				
                            
        				
                            
        				
                            
                				<a href="../../../../tags/index.html#Lua" title="Lua" rel="2">
                                    Lua
                                </a>
                            
        				
                            
                				<a href="../../../../tags/index.html#Requests" title="Requests" rel="2">
                                    Requests
                                </a>
                            
        				
                            
        				
                            
        				
                            
                				<a href="../../../../tags/index.html#Django" title="Django" rel="2">
                                    Django
                                </a>
                            
        				
                            
        				
                            
        				
                            
        				
                            
                				<a href="../../../../tags/index.html#AWK" title="AWK" rel="2">
                                    AWK
                                </a>
                            
        				
                            
        				
                            
        				
                            
        				
                            
        				
                            
        				
                            
        				
                            
        				
                            
                				<a href="../../../../tags/index.html#HBase" title="HBase" rel="2">
                                    HBase
                                </a>
                            
        				
                            
        				
                            
        				
                            
                				<a href="../../../../tags/index.html#Thrift" title="Thrift" rel="2">
                                    Thrift
                                </a>
                            
        				
                            
        				
                            
        				
                            
                				<a href="../../../../tags/index.html#Spider" title="Spider" rel="4">
                                    Spider
                                </a>
                            
        				
                            
        				
                            
        				
                            
                				<a href="../../../../tags/index.html#Selenium" title="Selenium" rel="2">
                                    Selenium
                                </a>
                            
        				
                            
                				<a href="../../../../tags/index.html#PhantomJS" title="PhantomJS" rel="2">
                                    PhantomJS
                                </a>
                            
        				
                            
        				
                            
        				
                            
        				
                            
        				
                            
        				
                            
        				
                            
        				
                            
        				
                            
        				
                            
        				
                            
        				
                            
        				
                            
        				
                            
        				
                            
        				
                            
        				
                            
        				
                            
        				
        			</div>
                </section>
                

                <!-- Friends Blog -->
                
                <hr>
                <h5>FRIENDS</h5>
                <ul class="list-inline">
                    
                        <li><a href="http://pmars.cnblogs.com">pmars的博客</a></li>
                    
                        <li><a href="http://weibo.com/topmars">pmars的微博</a></li>
                    
                        <li><a href="http://github.com/pmars">我的项目</a></li>
                    
                </ul>
                
            </div>
        </div>
    </div>
</article>








<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>
<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script>
    async("http://cdn.bootcss.com/anchor-js/1.1.1/anchor.min.js",function(){
        anchors.options = {
          visible: 'always',
          placement: 'right',
          icon: '#'
        };
        anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
    })
</script>
<style>
    /* place left on bigger screen */
    @media all and (min-width: 800px) {
        .anchorjs-link{
            position: absolute;
            left: -0.75em;
            font-size: 1.1em;
            margin-top : -0.1em;
        }
    }
</style>



    <!-- Footer -->
<!-- jQuery -->
<script src="../../../../js/jquery.min.js"></script>

<!-- Bootstrap Core JavaScript -->
<script src="../../../../js/bootstrap.min.js"></script>

<!-- Custom Theme JavaScript -->
<script src="../../../../js/hux-blog.min.js"></script>


<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    
                    <li>
                        <a href="../../../../feed.xml">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    

                    <!-- add Weibo, Zhihu by Hux, add target = "_blank" to <a> by Hux -->
                    
                    <li>
                        <a target="_blank" href="https://www.zhihu.com/people/xiaoh">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa  fa-stack-1x fa-inverse">知</i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li>
                        <a target="_blank" href="http://weibo.com/topmars">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-weibo fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    


                    
                    
                    <li>
                        <a target="_blank" href="https://github.com/pmars">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                </ul>
                <p class="copyright text-muted">
                    Copyright &copy; Xiaoh's Blog 2020
                    <!--br-->
                    | Theme © <a href="../../../../index.html">Xiaoh</a> |
                    Hosted by <a rel="nofollow" href="https://pages.coding.me" style="font-weight: bold">Coding Pages</a>
                    <!--iframe
                        style="margin-left: 2px; margin-bottom:-5px;"
                        frameborder="0" scrolling="0" width="91px" height="20px"
                        src="https://ghbtns.com/github-btn.html?user=pmars&repo=pmars.github.io&type=star&count=true" >
                    </iframe-->
                    <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
                    <span id="busuanzi_container_site_pv" style='display:none'> | View <span id="busuanzi_value_site_pv"></span> Times</span>
                </p>
            </div>
        </div>
    </div>
    <div class="actGotop" style="">
        <div class="plane"></div>
        <div class="back-info">返回顶部</div>
    </div>
    <script>
        (function() {
            $(window).scroll(function(){
                if($(window).scrollTop()>500){
                    $('.actGotop').fadeIn();
                }else{
                    $('.actGotop').fadeOut();
                }
            }) 
            $('.actGotop').click(function(){
                $(window).scrollTop(0);
            });
        })();
    </script>
</footer>

<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>

<!-- Highlight.js -->
<script>
    async("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function(){
        hljs.initHighlightingOnLoad();
    })
    // only load tagcloud.js in tag.html
    if($('#tag_cloud').length !== 0){
        async("/js/jquery.tagcloud.js",function(){
            $.fn.tagcloud.defaults = {
                //size: {start: 1, end: 1, unit: 'em'},
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>
<link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet">

<!--fastClick.js -->
<script>
    async("http://cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js", function(){
        // var $nav = document.querySelector("nav");
        // if($nav) FastClick.attach($nav);

        // global FastClick!!
        FastClick.attach(document.body);    
    })
</script>


<!-- Google Analytics -->

<script>
    // dynamic User by Hux
    var _gaId = 'UA-73800419-1';
    var _gaDomain = 'www.xiaoh.me';

    // Originial
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', _gaId, _gaDomain);
    ga('send', 'pageview');
</script>



<!-- Baidu Tongji -->

<script>
    // dynamic User by Hux
    var _baId = 'eb09bda7042f7733bd1bcba14d69d750';

    // Originial
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?" + _baId;
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
</script>




<!-- Image to hack wechat -->
<img src="../../../../img/icon_wechat.png" width="0" height="0" />
<!-- Migrate from head to bottom, no longer block render and still work -->

</body>

</html>
